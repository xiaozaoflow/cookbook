## 微信裂变 活动报名

### 1: 什么是微信裂变

![](/assets/大卫不可以.jpg)

因为微信拥有庞大的社交生态，每个人都有上百位好友，可以通过用户把产品分享给好友，一传十，十传百，像病毒一样传播，达到裂变的效果。就像之前的拼多多是玩这个发家的。裂变是获取用户最快的方式，但是操作难度也特别高，流程高度自动化、标准化。

我们的裂变主要是基于带小程序码的海报。举个例子用户如果想看大卫不可以这个绘本集中的一本绘本，微信扫描海报以后就会进入到小程序的绘本页阅读其中的一本。如果想阅读绘本集中其余的绘本，需要用户把海报分享给用户，邀请好友帮自己解锁。当好友数超过4个或者指定的人数以后就可以观看剩下所有的绘本。好友为了阅读绘本又会继续分享海报给自己的好友，就像细胞裂变一样，1变2，2变4。

### 2： 业务逻辑

> 海报流转的逻辑

假设用户A是第一级用户，指不通过裂变渠道获取到绘本的用户。什么意思呢，举个简单的例子，A有高途阅读小程序，在小程序首页阅读到了大卫不可以。然后为了读剩下的绘本，A需要朋友帮助他解锁。我们会为A生成一张海报，他可以分享给朋友邀请他们来解锁。这个时候，A是这个裂变链条的第一环。

B是A的朋友，他看到了A的海报，扫描了海报上的小程序码，进入小程序以后帮助到A解锁。此时A帮忙解锁的好友数量+1，B可以阅读大卫不可以，同时需要为B生成一张海报。此时, B是这个裂变链条的第二环。同样B还可以继续分享他的海报给C，获取到他的下游。

代码上看可以分成两个阶段。主要是【为一个用户生成海报】和 【某个用户点击海报之后发生的事情】。其中后者是最关键的因素，因为只有后者给用户带来的价值足够多，才会让用户继续分享给他的朋友。这个链条才可以转动起来。

海报就像下面这样。

![](/assets/海报.jpg)

> 海报生成的逻辑

海报的主要构成是图片本身相关的因素和小程序码。图片本身的比如背景图，背景图上的图层和一些控件，这些都是前端需要的，和后端关系不大。重要的是小程序码。小程序码执行的功能是，用户扫了海报跳转到小程序页面需要交代用户扫码之前的信息。这些信息都非常重要，包括【用户从哪里进来-渠道信息】，【用户是扫描哪个人的海报-助力信息】，【公众号或者小程序信息-基础信息】等，这些信息能否正确的传递直接影响了链条是否可以进入下一环。

> 扫描小程序码以后的逻辑

之前说代码逻辑可以拆成海报生成和海报扫描以后两个阶段。第二个阶段需要做的事情是，用户扫了海报以后进入到绘本阅读页，给他帮忙解锁的人增加一个好友计数，为该用户生成海报和发送消息，记录一个报名事件，这样用户下次进来的时候我们知道他曾经看过这个绘本。

> 抽象和迁移

上面的两个过程，本质上就是生成一段参数来记录信息，然后把参数放在某个载体中。例子中的载体是海报上的小程序码。然后，用户通过某种方式把参数携带到另一个地方。小程序码就是跳转小程序页面，公众号二维码就是关注二维码。然后，发生扫码后事件的流程。由于这个过程本身是可以复制和迁移的。因此除了海报裂变以外，还有小程序卡片消息，公众号二维码，小程序分享等等都可以替换海报，发挥同样的作用。

### 3：代码实现

整个裂变过程的流程如下。代码还是分为两个过程讲解，分别是海报生成和扫码后事件。

processOn链接：[https://www.processon.com/view/link/5ef064926376891e81de9355](https://www.processon.com/view/link/5ef064926376891e81de9355)

![](/assets/小程序裂变流程.png)

> 海报生成逻辑

海报中的参数其实就是一段字符串。比如appId=wx18dd82265bdf8e6a&id=81&channelId=3&inviteSceneId=1787，appid记录了公众号信息，channelId记录了渠道消息，inviteScenenId是inviteScene表中的主键，记录了邀请场景的信息。所以如果要生成一个带参数的小程序码，需要先合成字符串确定码上要携带的参数。这段代码逻辑参考maAcodeController.getUnlimited。

值得注意的是，由于微信小程序码携带的参数长度是有限的，小于32个字符。小程序码中的参数还需要带要跳转的页面路径，通常是这样子的，pages/bookList/bookList?id=128，问号前面是跳转路径，后面是参数。我们的参数通常很长，所以这里做了一个入库。这个id=128是ma\_qrcode的主键。前端拿到id=128以后会调后端parseScene接口，把id=128还原成字符串appId=wx18dd82265bdf8e6a&id=81&channelId=3&inviteSceneId=1787。

海报的生成在小程序生成之上就是多了一层图像的生成。这段代码参考InviteService.generateActivityPoster。

> 扫码后事件

扫码以后发生的事情主要参考ActivityController.enroll。报名以后发布了报名事件，消息事件，邀请事件，分别对应用户扫了海报以后进入到绘本阅读页，给他帮忙解锁的人增加一个好友计数，为该用户生成海报和发送消息，记录一个报名事件。值得注意的是，消息事件主要是指公众号消息。发送消息的openid需要区user-openid表中获取。而帮助某个用户解锁的好友数量的计数是从invite-relation中来的。

### 4: 数据库er图

![](/assets/截屏2021-07-20 下午4.48.56.png)

